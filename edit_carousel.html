<!DOCTYPE html>
<html>
  <head>
    <title>Deep Treble - Edit Carousel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="main.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="third_party/mustache.js"></script>
  </head>
  <body>

    <!-- Wrap the contents of the page so that if the page is shorter than the height of the browser, it will let the footer stick to the bottom. -->
    <div class='wrap'>

      <!-- Include the header of the website, which is shared throughout. -->
      <header></header>

      <!-- The glow and white fill of the content of the page -->
      <div class='container'>
        <div id="actualContent" class="whitefill blackglow">
          <center><h2><span class='text-danger'>Deep Treble</span> Member Admin Page</h2></center>
          <div class='whitespace'></div>
          <div class="form-horizontal" role="form">
            <div class="form-group">
              <label for="inputPassword" class="col-sm-2 control-label">Password</label>
              <div class="col-sm-10">
                <input type="password" class="form-control" id="inputPassword" placeholder="Password">
              </div>
            </div>

            <input id="addMember" type=submit class="btn btn-default" value="Add New Image">
            <div class="whitespace"></div>
            <div id="appendHere"></div>

            <script id="panelRender" type="text/html">
              {{#images}}
                {{> panelTemplate}}
              {{/images}}
            </script>


            <script id="panelTemplate" type="text/html">
              <div class="panel-group" role="tablist">
                <div class="panel panel-default">
                  <div class="panel-heading" role="tab">
                    <h4 class="panel-title">
                      <a class="" data-toggle="collapse" href="#collapseListGroup-{{index}}" aria-expanded="true" aria-controls="collapseListGroup">
                        Entry {{#addOne}}{{index}}{{/addOne}}
                      </a>
                      <div class="delete" style="float:right;cursor:pointer;">Delete</div>
                    </h4>
                  </div>
                  <div id="collapseListGroup-{{index}}" style="padding:15px;" class="panel-collapse collapse" role="tabpanel" aria-expanded="true" style="">
                    <div class="form-group">
                      <label for="inputURL-{{index}}" class="col-sm-3 control-label">URL to go to</label>
                      <div class="col-sm-9">
                        <input type="text" class="form-control" id="inputURL-{{index}}" value="{{url}}">
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="inputFile-{{index}}" class="col-sm-3 control-label">Image</label>
                      <div class="col-sm-9">
                        <input type="file" id="inputFile-{{index}}">
                        <p class="help-block">Only input a new file if you want to replace the old one.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </script>

            <div class="whitespace"></div>
            <input id="saveButton" type=submit class="btn btn-default" value="Save">

          </div>
        </div>
      </div>
      <div id='push'></div>
    </div>
    <footer></footer>
    <script type="text/javascript">

      function deleteCur(e) {
        $(e.target).closest('.panel-group').remove();
      }

      $(document).ready(function() {
        'use strict';

        // Render our headers and footers.
        $.get('header.html', function(data) {
          $('header').html(data);
        });
        $.get('footer.html', function(data) {
          $('footer').html(data);
        });

        var view = {
          addOne: function() {
            return function(text, render) {
              return parseInt(render(text)) + 1;
            }
          }
        };

        // Render the accordian widgets
        $.getJSON('data/carousel.json', function(data) {

          // Add member data to the "view"
          view.images = data;

          // Render view
          var outer = $('#panelRender').html();
          var inner = $('#panelTemplate').html();
          var rendered = Mustache.render(outer, view, {panelTemplate: inner});
          $('#appendHere').append(rendered);

          // Setup button event listener for close buttons
          var deleteButtons = document.body.querySelectorAll('.delete');
          for (var i = 0; i < deleteButtons.length; ++i) {
            deleteButtons[i].addEventListener('click', deleteCur);
          }

          // Setup button event listener for add member button
          window.NEW_PHOTO_COUNT = data.length;
          var addButton = document.body.querySelector('#addMember');
          addButton.addEventListener('click', function() {
            var tem = $('#panelTemplate').html();
            var newView = {addOne: view.addOne, index: window.NEW_PHOTO_COUNT};
            window.NEW_PHOTO_COUNT += 1;
            var newRend = Mustache.render(tem, newView);
            $('#appendHere').append(newRend);
            
            // Add event listener on the last delete button. This works because it was appended
            var delButtons = document.body.querySelectorAll('.delete');
            var delButton = delButtons[delButtons.length - 1];
            if (delButton) {
              delButton.addEventListener('click', deleteCur);
            }

            // Open up the accordian
            var accs = document.body.querySelectorAll('[id^=collapseListGroup-]');
            var acc = accs[accs.length - 1];
            if (acc) {
              acc.classList.remove('collapse');
              acc.classList.add('in');
            }
              
          });

          // Setup save button.
          var save = document.body.querySelector('#saveButton');
          save.addEventListener('click', function() {

            // Create data to be sent to the server.
            var formData = new FormData();

            // Skeleton of data sent to server.
            var sendJSON = [];

            // Iterate over each accordian widget.
            var allImages = document.body.querySelectorAll('[id^=collapseListGroup-]');
            for (var i = 0; i < allImages.length; ++i) {
              var image = allImages[i];
              var url = image.querySelector('[id^=inputURL]').value;
              var file = image.querySelector('[id^=inputFile]').files[0];

              // Create an object to add to the server packet.
              sendJSON.push({
                index: i,
                url: url
              });

              // If there is a file, also add it separately to the packet.
              if (file) {
                formData.append(i, file);
              }
            }

            // Add in password and data to the packet.
            JSON.stringify(sendJSON);
            formData.append('data', JSON.stringify(sendJSON));
            formData.append('password', document.body.querySelector('#inputPassword').value);

            // Send to server.
            var req = new XMLHttpRequest();
            req.open('POST', 'update_carousel.php');
            req.onload = function(event) { alert(event.target.responseText); };
            req.send(formData);
          });
        });
      });
    </script>
    <script src="js/main.js"></script>
  </body>
</html>
